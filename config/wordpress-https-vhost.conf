<VirtualHost 127.0.0.1:443 _default_:443>
  ServerName kayarine.club
  ServerAlias www.kayarine.club
  SSLEngine on
  SSLCertificateFile "/opt/bitnami/apache/conf/kayarine.club.crt"
  SSLCertificateKeyFile "/opt/bitnami/apache/conf/kayarine.club.key"
  DocumentRoot /opt/bitnami/wordpress

  # --- WEBHOOK & CHAT PROXY START ---
  # Proxy /webhook requests to the local Flask app (WhatsApp)
  ProxyPass /webhook http://127.0.0.1:5000/webhook
  ProxyPassReverse /webhook http://127.0.0.1:5000/webhook
  
  # Proxy /chat (UI)
  ProxyPass /chat http://127.0.0.1:5000/chat
  ProxyPassReverse /chat http://127.0.0.1:5000/chat

  # Proxy /api (Chat API)
  ProxyPass /api http://127.0.0.1:5000/api
  ProxyPassReverse /api http://127.0.0.1:5000/api

  # Proxy /static (For UI assets if needed, though Tailwind CDN handles it for now)
  ProxyPass /static http://127.0.0.1:5000/static
  ProxyPassReverse /static http://127.0.0.1:5000/static
  
  # Legacy Proxy for Inventory Check (if plugin uses /kayarine-api)
  ProxyPass /kayarine-api http://127.0.0.1:5000/api
  ProxyPassReverse /kayarine-api http://127.0.0.1:5000/api
  # --- WEBHOOK & CHAT PROXY END ---

  # BEGIN: Configuration for letsencrypt
  Include "/opt/bitnami/apps/letsencrypt/conf/httpd-prefix.conf"
  # END: Configuration for letsencrypt
  # BEGIN: Support domain renewal when using mod_proxy without Location
  <IfModule mod_proxy.c>
    ProxyPass /.well-known !
  </IfModule>
  # END: Support domain renewal when using mod_proxy without Location
  # BEGIN: Enable www to non-www redirection
  RewriteEngine On
  RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
  RewriteCond %{HTTP_HOST} !^localhost
  RewriteCond %{HTTP_HOST} !^[0-9]+.[0-9]+.[0-9]+.[0-9]+(:[0-9]+)?$
  RewriteCond %{REQUEST_URI} !^/\.well-known
  RewriteRule ^(.*)$ https://%1$1 [R=permanent,L]
  # END: Enable www to non-www redirection
  Alias /.well-known /opt/bitnami/wordpress/.well-known
  <Directory "/opt/bitnami/wordpress/.well-known">
  Options -Indexes
  AllowOverride None
  Require all granted
  </Directory>
  <Directory "/opt/bitnami/wordpress">
    Options -Indexes +FollowSymLinks -MultiViews
    AllowOverride All
    Require all granted
    # BEGIN WordPress fix for plugins and themes
    # Certain WordPress plugins and themes do not properly link to PHP files because of symbolic links
    # https://github.com/bitnami/bitnami-docker-wordpress-nginx/issues/43
    RewriteEngine On
    RewriteRule ^bitnami/wordpress(/.*) $1 [L]
    # END WordPress fix for plugins and themes
    # BEGIN WordPress
    # https://wordpress.org/support/article/htaccess/#basic-wp
    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/wp-includes/  
    RewriteRule . /index.php [L]
    # END WordPress
    # BEGIN Disable WordPress XML-RPC endpoint
    # Disable the outdated WordPress XML-RPC endpoint to prevent security vulnerabilities.
    # https://github.com/bitnami/containers/pull/51077
    <Files xmlrpc.php>
    Order Allow,Deny
    Deny from all
    </Files>
    # END Disable WordPress XML-RPC endpoint
  </Directory>
<Directory "/opt/bitnami/wordpress/wp-includes">
    AllowOverride All
    Require all granted
</Directory>
  Include "/opt/bitnami/apache/conf/vhosts/htaccess/wordpress-htaccess.conf"
  # BEGIN: Support domain renewal when using mod_proxy within Location
  <Location /.well-known>
    <IfModule mod_proxy.c>
      ProxyPass !
    </IfModule>
  </Location>
  # END: Support domain renewal when using mod_proxy within Location
</VirtualHost>
