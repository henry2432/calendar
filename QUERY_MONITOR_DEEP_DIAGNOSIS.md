# Query Monitor 深層診斷指南

## 為什麼 WordPress 核心優化沒有改善？

WordPress 核心優化（AUTOSAVE_INTERVAL、WP_POST_REVISIONS、EMPTY_TRASH_DAYS）沒有改善，說明：

❌ 自動保存不是瓶頸
❌ 修訂版本不是瓶頸
❌ 垃圾桶清理不是瓶頸

✅ **真正的瓶頸應該是：**
1. **資料庫查詢本身很慢**（缺失索引）
2. **某個特定插件**執行很慢的操作
3. **Elementor 渲染**
4. **主題初始化**

---

## Query Monitor 完整診斷流程

### 步驟 1：訪問前端頁面

```
1. 訪問網站首頁或任意 Elementor 頁面
2. 確保已登入（Query Monitor 只對管理員顯示）
```

### 步驟 2：打開 Query Monitor

**位置：** 頁面左上角 **QM** 按鈕

```
┌─────────────────────────────────────┐
│ QM  (Query Monitor 按鈕)            │
│    • Queries
│    • Database
│    • PHP Errors
│    • Hooks
│    • etc.
└─────────────────────────────────────┘
```

### 步驟 3：檢查關鍵指標

#### 📊 Queries 標籤 - 最重要

```
進入 QM → Queries 標籤

看到的數據：
┌────────────────────────────────────────┐
│ 總查詢數量：                            │
│ _____ queries in _____ seconds         │
│                                        │
│ 查詢列表：                              │
│ [查詢 1] 0.0234s  SELECT * FROM ...   │
│ [查詢 2] 0.0156s  UPDATE wp_posts ... │
│ [查詢 3] 0.0089s  SELECT * FROM ...   │
│ [慢查詢] 0.2345s  SELECT ... WHERE ... │
└────────────────────────────────────────┘
```

**需要記錄的數據：**
```
1️⃣ 總查詢數量
   目標：< 100 個
   您的情況可能：150-300+ 個

2️⃣ 總查詢耗時
   目標：< 0.5 秒
   您的情況可能：1-2 秒

3️⃣ 最慢的查詢
   點擊每個慢查詢查看調用者
   目標：最慢查詢 < 0.1 秒
```

#### 🔍 查看最慢的查詢

```
操作：
1. QM → Queries
2. 點擊「Slow Queries」標籤
3. 查看耗時 > 0.05s 的查詢

分析：
- 查詢內容：SELECT ... WHERE ...
- 耗時：0.xxx 秒
- 調用者：哪個插件或主題執行的

例子（常見問題）：
❌ SELECT * FROM wp_posts WHERE 1=1; (0.234s)
   → 沒有 WHERE 條件，很慢

❌ SELECT * FROM wp_postmeta; (0.456s)
   → 未使用 post_id 索引，掃描全表

✅ SELECT * FROM wp_posts WHERE post_type='post' AND post_status='publish'; (0.012s)
   → 使用索引，很快
```

#### 📁 Database 標籤 - 查看表信息

```
QM → Database

顯示：
- wp_posts 表大小
- wp_postmeta 表大小
- 索引信息
```

#### 🔌 Hooks 標籤 - 查看插件初始化

```
QM → Hooks

查看：
- wp_footer（頁面底部）
- wp_head（頁面頭部）
- init（WordPress 初始化）

哪個插件在這些鉤子上執行最多代碼？
通常會找到性能殺手
```

---

## 詳細診斷步驟

### 第 1 輪：獲取基線數據

**訪問首頁並記錄：**

```
查詢數量：_____
查詢耗時：_____ 秒
最慢查詢：_____ 秒（查詢：_____________）
調用者：_____________（插件/主題）
```

### 第 2 輪：識別緩慢查詢模式

**點擊最慢的 5-10 個查詢，記錄：**

```
查詢 1：
├─ SQL：SELECT * FROM wp_postmeta WHERE ...
├─ 耗時：0.234s
├─ 調用者：Elementor Pro
└─ 問題：缺失 (post_id, meta_key) 索引

查詢 2：
├─ SQL：SELECT * FROM wp_posts WHERE ...
├─ 耗時：0.156s
├─ 調用者：Kayarine Booking
└─ 問題：缺失 (post_type, post_status) 索引

查詢 3：
├─ SQL：SELECT * FROM wp_options WHERE ...
├─ 耗時：0.089s
├─ 調用者：WordPress Core
└─ 問題：可能需要優化
```

### 第 3 輪：分析數據庫狀態

**QM → Database → 檢查：**

```
1. 表大小（表明垃圾數據量）：
   wp_posts 表：___ 行
   wp_postmeta 表：___ 行（通常是 posts 的 5-10 倍）

2. 索引列表：
   wp_postmeta 的索引：
   ☑ post_id（YES/NO）
   ☑ meta_key（YES/NO）
   ☑ meta_value（YES/NO）

3. 空間占用：
   wp_posts：___ MB
   wp_postmeta：___ MB
   
   > 50MB 說明可能有很多垃圾數據
```

### 第 4 輪：識別插件瓶頸

**QM → Hooks → 檢查：**

```
wp_footer 鉤子（頁面底部執行）：
- 哪個插件？_____________
- 執行了多少代碼？_____________
- 大概耗時？_____________

wp_head 鉤子（頁面頭部執行）：
- 哪個插件？_____________
- 執行了多少代碼？_____________
- 大概耗時？_____________
```

---

## 預期診斷結果

### 情況 A：查詢耗時 > 1 秒（最常見）

```
問題：資料庫查詢太慢
原因：缺失索引

解決：
1. 識別最慢的查詢
2. 添加適當的索引
3. 執行 OPTIMIZE TABLE

預計改善：-200-800ms
```

### 情況 B：查詢數量 > 200（也常見）

```
問題：N+1 查詢問題
原因：循環中執行查詢

解決：
1. 使用 Transient 快取
2. 使用 get_posts() 而不是 WP_Query 循環
3. 優化插件代碼

預計改善：-300-1000ms
```

### 情況 C：某插件特別慢

```
問題：特定插件性能不佳
原因：該插件設計不優化

解決：
1. 禁用該插件測試
2. 尋找替代插件
3. 聯繫插件開發者

預計改善：-100-500ms
```

---

## 快速查看技巧

### 查看查詢詳情

```
1. QM 面板中點擊任何查詢
2. 展開詳情：

Query: SELECT * FROM wp_postmeta WHERE post_id = 123 AND meta_key = '_price'
Component: WooCommerce
Caller: WC_Product->get_price()
Time: 0.0456 seconds

執行計劃：
┌────────────────────────────────┐
│ EXPLAIN 結果                    │
│ type: range/ref（好）           │
│ rows: 3（掃描 3 行）            │
│ Extra: Using where             │
└────────────────────────────────┘
```

### 導出查詢數據

```
QM 面板底部有「Export」按鈕
下載完整的查詢日誌（JSON 格式）
可用於進一步分析
```

---

## 根據診斷結果的優化路徑

### 如果最慢查詢 > 0.1s（缺失索引）

```
→ 執行數據庫優化
  - 添加 4 個關鍵索引
  - 執行 OPTIMIZE TABLE
  - 預計改善 -200-800ms
```

### 如果查詢數量 > 200（N+1 問題）

```
→ 優化代碼
  - 使用 Transient 快取
  - 批量查詢而不是循環查詢
  - 預計改善 -300-1000ms
```

### 如果某插件特別慢

```
→ 禁用該插件
  - 測試無該插件的加載時間
  - 決定是否保留該插件
  - 預計改善 -100-500ms
```

---

## 下一步建議

1. **現在就做：** 打開 Query Monitor，收集診斷數據
2. **記錄結果：** 
   - 總查詢數：___
   - 總耗時：___ 秒
   - 最慢查詢：___ 秒
   - 最慢查詢來自：___

3. **根據結果選擇優化：**
   - 若缺失索引 → 數據庫優化
   - 若 N+1 問題 → 代碼優化
   - 若插件慢 → 替換插件

---

## 常見 Query Monitor 問題

### Q: 看不到 Query Monitor 面板？
```
A: 
1. 確保已登入（QM 只對管理員顯示）
2. 確保 Query Monitor 插件已啟用
3. 頁面刷新後應該在左上角看到 QM 按鈕
```

### Q: 查詢太多，怎麼找重點？
```
A:
1. 點擊「Slow Queries」標籤，只看慢查詢
2. 點擊每個查詢，查看「調用者」信息
3. 記錄耗時最長的 5-10 個查詢
```

### Q: 怎麼知道是哪個插件導致的？
```
A:
1. QM 會顯示「Component」欄位
2. 通常是插件或主題名稱
3. 若不清楚，點擊詳情查看完整調用堆棧
```

---

## 完成診斷後

一旦收集到詳細數據，可以：

1. **確定真正的瓶頸**
   - 是查詢速度？
   - 是查詢數量？
   - 是某個插件？

2. **選擇最有效的優化**
   - 數據庫優化：適合查詢速度問題
   - 代碼優化：適合查詢數量問題
   - 禁用/替換：適合插件問題

3. **測試改善效果**
   - 優化後再用 Query Monitor 檢查
   - 對比前後數據
   - 確認改善幅度

**目標：** 將查詢耗時從 1-2 秒降至 0.3-0.5 秒，最終加載時間達 1.3 秒以下
